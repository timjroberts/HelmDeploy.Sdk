<Project>
    <UsingTask TaskName="HelmDeploy.Sdk.Tasks.GenerateHelmApplicationFiles" AssemblyFile="$(MSBuildThisFileDirectory)/../lib/netstandard2.0/HelmDeploy.Sdk.Tasks.dll" />

    <Target Name="RestoreProjectReferences"
            AfterTargets="_GenerateProjectRestoreGraph"
            DependsOnTargets="_RestoreProject;_CreateProjectDirectories">
    </Target>

    <Target Name="CompileHelmChart"
            BeforeTargets="CoreCompile"
            DependsOnTargets="RestoreProjectReferences">
        <PropertyGroup>
            <TargetDirectory>$(MSBuildProjectDirectory)/obj/$(Configuration)/$(ApplicationName)</TargetDirectory>
            <ApplicationVersion>$(ApplicationMajorVersion).$(ApplicationMinorVersion).$(ApplicationPatchVersion)$(ApplicationVersionSuffix)</ApplicationVersion>
        </PropertyGroup>

        <MakeDir Directories="$(TargetDirectory)" />

        <GenerateHelmApplicationFiles ProjectDirectory="$(MSBuildProjectDirectory)" TargetDirectory="$(TargetDirectory)"
                                      ApplicationName="$(ApplicationName)"
                                      ApplicationVersion="$(ApplicationVersion)"
                                      ApplicationDescription="$(ApplicationDescription)"
                                      RepositoryPrefix="$(RepositoryPrefix)"
                                      ProjectReferences="@(ProjectReference)" />
    </Target>

    <Target Name="_CreateProjectDirectories">
        <MakeDir Directories="@(ProjectReference->'$(MSBuildProjectDirectory)/obj/%(Filename)')" />
    </Target>

    <Target Name="_CreateProjectLinks">
        <ItemGroup>
            <_LinkCmd Include="@(ProjectReference->'ln -s %(RootDir)%(Directory) obj/%(Filename)/Sources')"
                      Condition="'$(OS)' == 'Unix' And !Exists('obj/%(Filename)/Sources')" />
            <_LinkCmd Include="@(ProjectReference->'mklink /d obj/%(Filename)/Sources %(RootDir)%(Directory)')"
                      Condition="'$(OS)' == 'Windows_NT' And !Exists('obj/%(Filename)/Sources')" />
        </ItemGroup>

        <Exec Command="%(_LinkCmd.Identity)" WorkingDirectory="$(MSBuildProjectDirectory)" Condition="'@(_LinkCmd)' != ''" />
    </Target>

    <Target Name="_GenerateAzdsTemplateForProject" DependsOnTargets="_CreateProjectDirectories;_CreateProjectLinks">
        <ItemGroup>
            <_AzdsProjectReference Include="@(ProjectReference)" Condition="'%(FullPath)' == '$(ProjectFilePath)'" />
        </ItemGroup>

        <Message Importance="high" Text="Generating AZDS template for '%(_AzdsProjectReference.Filename) -> %(_AzdsProjectReference.FullPath)'" />
    </Target>

    <Target Name="_RestoreProject"
            Condition="!Exists('$(ProjectAssetsFile)')">
        <MSBuild Projects="$(MSBuildProjectFile)" Targets="Restore" />
    </Target>

</Project>
